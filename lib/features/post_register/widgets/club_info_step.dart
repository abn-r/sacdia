import 'package:flutter/material.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:sacdia/core/catalogs/bloc/catalogs_bloc.dart';
import 'package:sacdia/core/catalogs/bloc/catalogs_event.dart' as catalog_events;
import 'package:sacdia/core/catalogs/bloc/catalogs_state.dart';
import 'package:sacdia/core/catalogs/models/country.dart';
import 'package:sacdia/core/catalogs/models/union.dart';
import 'package:sacdia/core/catalogs/models/local_field.dart';
import 'package:sacdia/core/constants.dart';
import 'package:sacdia/core/widgets/selector_data_widget.dart';
import 'package:sacdia/features/post_register/bloc/post_register_bloc.dart';
import 'package:sacdia/features/post_register/bloc/post_register_event.dart';
import 'package:sacdia/features/post_register/bloc/post_register_state.dart';
import 'package:sacdia/features/post_register/models/club_models.dart';
import 'package:sacdia/features/post_register/widgets/selection_modal.dart';

class ClubInfoStep extends StatefulWidget {
  const ClubInfoStep({super.key});

  @override
  State<ClubInfoStep> createState() => _ClubInfoStepState();
}

class _ClubInfoStepState extends State<ClubInfoStep> {
  final _formKey = GlobalKey<FormState>();
  final _scrollController = ScrollController();
  bool _didShowSuccessMessage = false;

  final _countryController = TextEditingController();
  final _unionController = TextEditingController();
  final _localFieldController = TextEditingController();
  final _clubController = TextEditingController();
  final _clubTypeController = TextEditingController();
  final _classController = TextEditingController();

  Country? selectedCountry;
  Union? selectedUnion;
  LocalField? selectedLocalField;
  Club? selectedClub;
  ClubType? selectedClubType;
  Class? selectedClass;

  bool canSelectUnion = false;
  bool canSelectLocalField = false;
  bool canSelectClub = false;
  bool canSelectClubType = false;
  bool canSelectClass = false;
  bool isClubInfoComplete = false;

  List<Country> countries = [];
  List<Union> unions = [];
  List<LocalField> localFields = [];
  List<Club> clubs = [];
  List<ClubType> clubTypes = [];
  List<Class> classes = [];

  final Set<String> _notifiedAutoSelections = {};

  @override
  void initState() {
    super.initState();
    
    // Asegurar que se muestre desde el inicio
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_scrollController.hasClients) {
        _scrollController.jumpTo(0);
      }
      
      // Solicitar carga de pa√≠ses al iniciar
      context.read<PostRegisterBloc>().add(const LoadCountriesRequested());
      
      // Asegurarnos de que la bandera de mensaje est√© limpia al iniciar
      _didShowSuccessMessage = false;
    });
  }

  @override
  void dispose() {
    _scrollController.dispose();
    _countryController.dispose();
    _unionController.dispose();
    _localFieldController.dispose();
    _clubController.dispose();
    _clubTypeController.dispose();
    _classController.dispose();
    super.dispose();
  }

  void _resetSuccessMessageFlag() {
    if (_didShowSuccessMessage) {
      setState(() {
        _didShowSuccessMessage = false;
      });
    }
  }

  void _showCountrySelectionModal() {
    _resetSuccessMessageFlag();
    
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => BlocBuilder<CatalogsBloc, CatalogsState>(
        builder: (context, state) {
          if (state is CatalogsLoading) {
            return const Center(child: CupertinoActivityIndicator());
          }

          if (state is CatalogsError) {
            return Container(
              color: Colors.white,
              child: Center(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text('Error: ${state.message}',
                        style: const TextStyle(color: Colors.red)),
                    const SizedBox(height: 16),
                    ElevatedButton(
                      onPressed: () => Navigator.pop(context),
                      child: const Text('Cerrar'),
                    ),
                  ],
                ),
              ),
            );
          }

          if (state is CatalogsLoaded) {
            return SelectionModal(
              title: 'Seleccionar Pa√≠s',
              subtitle: 'Elige el pa√≠s en el que te encuentras',
              items: state.countries,
              selectedItems: selectedCountry != null ? [selectedCountry!] : [],
              itemBuilder: (country) => Text((country as Country).name),
              onConfirm: (selected) {
                if (selected.isNotEmpty) {
                  final country = selected.first as Country;
                  
                  // Enviar selecci√≥n al bloc
                  context.read<PostRegisterBloc>().add(CountrySelected(country));
                  
                  setState(() {
                    selectedCountry = country;
                    _countryController.text = selectedCountry!.name;

                    // Resetear selecciones dependientes
                    selectedUnion = null;
                    selectedLocalField = null;
                    selectedClub = null;
                    selectedClubType = null;
                    selectedClass = null;

                    _unionController.clear();
                    _localFieldController.clear();
                    _clubController.clear();
                    _clubTypeController.clear();
                    _classController.clear();

                    // Permitir seleccionar uni√≥n
                    canSelectUnion = true;
                    canSelectLocalField = false;
                    canSelectClub = false;
                    canSelectClubType = false;
                    canSelectClass = false;
                    isClubInfoComplete = false;

                    // Filtrar uniones para este pa√≠s
                    unions = state.unions
                        .where((union) =>
                            union.countryId == selectedCountry!.countryId)
                        .toList();
                  });
                }
              },
            );
          }

          return const SizedBox.shrink();
        },
      ),
    );
  }

  void _showUnionSelectionModal() {
    if (!canSelectUnion) return;
    
    _resetSuccessMessageFlag();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return BlocBuilder<CatalogsBloc, CatalogsState>(
          builder: (context, state) {
            if (state is! CatalogsLoaded) {
              return const Center(child: CupertinoActivityIndicator());
            }
            
            return SelectionModal(
              title: 'Seleccionar Uni√≥n',
              subtitle: 'Elige la uni√≥n a la que perteneces',
              items: unions,
              selectedItems: selectedUnion != null ? [selectedUnion!] : [],
              itemBuilder: (union) => Text((union as Union).name),
              onConfirm: (selected) {
                if (selected.isNotEmpty) {
                  final union = selected.first as Union;
                  
                  // Enviar selecci√≥n al bloc
                  context.read<PostRegisterBloc>().add(UnionSelected(union));
                  
                  setState(() {
                    selectedUnion = union;
                    _unionController.text = selectedUnion!.name;

                    // Resetear selecciones dependientes
                    selectedLocalField = null;
                    selectedClub = null;
                    selectedClubType = null;
                    selectedClass = null;

                    _localFieldController.clear();
                    _clubController.clear();
                    _clubTypeController.clear();
                    _classController.clear();

                    // Permitir seleccionar campo local
                    canSelectLocalField = true;
                    canSelectClub = false;
                    canSelectClubType = false;
                    canSelectClass = false;
                    isClubInfoComplete = false;

                    // Filtrar campos locales para esta uni√≥n
                    print('üîç Filtrando campos locales para unionId: ${selectedUnion!.unionId}');
                    print('üßæ Total de campos locales disponibles: ${state.localFields.length}');
                    
                    if (state.localFields.isNotEmpty) {
                      print('üìã Primer campo local: ${state.localFields.first}');
                    }
                    
                    localFields = state.localFields
                        .where((field) {
                          final matches = field.unionId == selectedUnion!.unionId;
                          print('üîÑ Campo local ${field.name} (unionId: ${field.unionId}) ¬øcoincide? $matches');
                          return matches;
                        })
                        .toList();
                    
                    print('üî¢ Campos locales filtrados: ${localFields.length}');
                  });
                }
              },
            );
          }
        );
      },
    );
  }

  void _showLocalFieldSelectionModal() {
    if (!canSelectLocalField) return;
    
    _resetSuccessMessageFlag();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return BlocBuilder<CatalogsBloc, CatalogsState>(
          builder: (context, state) {
            if (state is! CatalogsLoaded) {
              return const Center(child: CupertinoActivityIndicator());
            }
            
            print('üèõÔ∏è Mostrando modal de campos locales');
            print('üî¢ Campos locales disponibles para mostrar: ${localFields.length}');
            if (localFields.isEmpty && state.localFields.isNotEmpty) {
              // Intento de recuperaci√≥n si por alguna raz√≥n los campos filtrados est√°n vac√≠os
              print('‚ö†Ô∏è Lista localFields vac√≠a pero state.localFields tiene ${state.localFields.length} elementos');
              print('üîÑ Re-filtrando campos locales para unionId: ${selectedUnion?.unionId ?? "null"}');
              
              if (selectedUnion != null) {
                localFields = state.localFields
                    .where((field) => field.unionId == selectedUnion!.unionId)
                    .toList();
                print('üîÑ Despu√©s de re-filtrar: ${localFields.length} campos locales');
              }
            }
            
            return SelectionModal(
              title: 'Seleccionar Campo Local',
              subtitle: 'Elige el campo local al que perteneces',
              items: localFields,
              selectedItems:
                  selectedLocalField != null ? [selectedLocalField!] : [],
              itemBuilder: (field) => Text((field as LocalField).name),
              onConfirm: (selected) {
                if (selected.isNotEmpty) {
                  final localField = selected.first as LocalField;
                  
                  // Enviar selecci√≥n al bloc
                  context.read<PostRegisterBloc>().add(LocalFieldSelected(localField));
                  
                  setState(() {
                    selectedLocalField = localField;
                    _localFieldController.text = selectedLocalField!.name;

                    // Resetear selecciones dependientes
                    selectedClub = null;
                    selectedClubType = null;
                    selectedClass = null;

                    _clubController.clear();
                    _clubTypeController.clear();
                    _classController.clear();

                    // Permitir seleccionar club
                    canSelectClub = true;
                    canSelectClubType = false;
                    canSelectClass = false;
                    isClubInfoComplete = false;

                    // Cargar clubes del campo local seleccionado desde la API
                    context.read<CatalogsBloc>().add(
                          catalog_events.LoadClubsRequested(selectedLocalField!.localFieldId),
                        );
                  });
                }
              },
            );
          }
        );
      },
    );
  }

  void _showClubSelectionModal() {
    if (!canSelectClub) return;
    
    // Resetear flag de mensaje mostrado al iniciar una nueva selecci√≥n
    _resetSuccessMessageFlag();
    
    // Asegurarnos de cargar los clubes antes de mostrar el modal
    if (selectedLocalField != null) {
      print('üîÑ Cargando clubes para campo local: ${selectedLocalField!.name} (ID: ${selectedLocalField!.localFieldId})');
      context.read<CatalogsBloc>().add(
        catalog_events.LoadClubsRequested(selectedLocalField!.localFieldId),
      );
    }

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return BlocBuilder<CatalogsBloc, CatalogsState>(
          builder: (context, state) {
            if (state is! CatalogsLoaded) {
              print('‚ö†Ô∏è Estado de cat√°logos no cargado');
              return const Center(child: CupertinoActivityIndicator());
            }
            
            final clubs = state.clubs.where(
              (club) => club.localFieldId == selectedLocalField!.localFieldId
            ).toList();
            
            print('üìã Clubes encontrados en modal: ${clubs.length}');
            if (clubs.isEmpty) {
              print('‚ö†Ô∏è No hay clubes para mostrar para el campo local: ${selectedLocalField!.localFieldId}');
            } else {
              print('‚úÖ Clubes disponibles:');
              for (var club in clubs) {
                print('   - ${club.name} (ID: ${club.clubId})');
              }
            }
            
            return SelectionModal(
              title: 'Seleccionar Club',
              subtitle: clubs.isEmpty 
                ? 'No hay clubes disponibles para este campo local' 
                : 'Elige el club al que perteneces',
              items: clubs,
              selectedItems: selectedClub != null ? [selectedClub!] : [],
              itemBuilder: (club) => Text((club as Club).name),
              onConfirm: (selected) {
                if (selected.isNotEmpty) {
                  final club = selected.first as Club;
                  
                  // Enviar selecci√≥n al bloc
                  context.read<PostRegisterBloc>().add(ClubSelected(club));
                  
                  setState(() {
                    selectedClub = club;
                    _clubController.text = selectedClub!.name;

                    // Resetear selecciones dependientes
                    selectedClubType = null;
                    selectedClass = null;

                    _clubTypeController.clear();
                    _classController.clear();

                    // Permitir seleccionar tipo de club
                    canSelectClubType = true;
                    canSelectClass = false;
                    isClubInfoComplete = false;
                    
                    // Si no tenemos tipos de club cargados, los solicitamos
                    if (state.clubTypes.isEmpty) {
                      context.read<CatalogsBloc>().add(catalog_events.LoadClubTypesRequested());
                    }
                  });
                }
              },
            );
          },
        );
      },
    );
  }

  void _showClubTypeSelectionModal() {
    if (!canSelectClubType) return;
    
    // Resetear flag de mensaje mostrado al iniciar una nueva selecci√≥n
    _resetSuccessMessageFlag();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return BlocBuilder<CatalogsBloc, CatalogsState>(
          builder: (context, state) {
            if (state is! CatalogsLoaded) {
              return const Center(child: CupertinoActivityIndicator());
            }
            
            return SelectionModal(
              title: 'Seleccionar Tipo de Club',
              subtitle: 'Elige el tipo de club que est√°s cursando',
              items: state.clubTypes,
              selectedItems: selectedClubType != null ? [selectedClubType!] : [],
              itemBuilder: (type) => Text((type as ClubType).name),
              onConfirm: (selected) {
                if (selected.isNotEmpty) {
                  final clubType = selected.first as ClubType;
                  
                  // Enviar selecci√≥n al bloc
                  context.read<PostRegisterBloc>().add(ClubTypeSelected(clubType));
                  
                  setState(() {
                    selectedClubType = clubType;
                    _clubTypeController.text = selectedClubType!.name;

                    // Resetear clase
                    selectedClass = null;
                    _classController.clear();

                    // Permitir seleccionar clase
                    canSelectClass = true;
                    isClubInfoComplete = false;

                    // Cargar clases para este tipo de club
                    context.read<CatalogsBloc>().add(
                          catalog_events.LoadClassesRequested(selectedClubType!.clubTypeId),
                        );
                  });
                }
              },
            );
          },
        );
      },
    );
  }

  void _showClassSelectionModal() {
    if (!canSelectClass) return;
    
    // Resetear flag de mensaje mostrado al iniciar una nueva selecci√≥n
    _resetSuccessMessageFlag();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return BlocBuilder<CatalogsBloc, CatalogsState>(
          builder: (context, state) {
            if (state is! CatalogsLoaded) {
              return const Center(child: CupertinoActivityIndicator());
            }
            
            // Filtrar clases para el tipo de club seleccionado
            final availableClasses = state.classes.where((cls) {
              final matches = cls.clubTypeId == selectedClubType!.clubTypeId;
              return matches;
            }).toList();
                        
            if (availableClasses.isEmpty && state.classes.isNotEmpty) {
              
              return SelectionModal(
                title: 'Seleccionar Clase',
                subtitle: 'Elige la clase que est√°s cursando actualmente',
                items: state.classes,
                selectedItems: selectedClass != null ? [selectedClass!] : [],
                itemBuilder: (classItem) => Text((classItem as Class).name),
                onConfirm: (selected) {
                  if (selected.isNotEmpty) {
                    final selectedClassItem = selected.first as Class;
                    
                    // Enviar selecci√≥n al bloc
                    context.read<PostRegisterBloc>().add(ClassSelected(selectedClassItem));
                    
                    setState(() {
                      selectedClass = selectedClassItem;
                      _classController.text = selectedClass!.name;
                      isClubInfoComplete = true;
                    });
                  }
                },
              );
            }
            
            return SelectionModal(
              title: 'Seleccionar Clase',
              subtitle: 'Elige la clase que est√°s cursando actualmente',
              items: availableClasses,
              selectedItems: selectedClass != null ? [selectedClass!] : [],
              itemBuilder: (classItem) => Text((classItem as Class).name),
              onConfirm: (selected) {
                if (selected.isNotEmpty) {
                  final selectedClassItem = selected.first as Class;
                  
                  // Enviar selecci√≥n al bloc
                  context.read<PostRegisterBloc>().add(ClassSelected(selectedClassItem));
                  
                  setState(() {
                    selectedClass = selectedClassItem;
                    _classController.text = selectedClass!.name;
                    isClubInfoComplete = true;
                  });
                }
              },
            );
          },
        );
      },
    );
  }

  void _saveClubInfo() {
    // Resetear flag de mensaje mostrado al guardar
    _resetSuccessMessageFlag();
    
    if (_formKey.currentState?.validate() ?? false) {
      if (isClubInfoComplete) {
        // Ya no es necesario enviar estos eventos aqu√≠, ya que se env√≠an en el momento de la selecci√≥n
        context.read<PostRegisterBloc>().add(const SaveClubInfoRequested());
      }
    }
  }
  
  // M√©todo para mostrar notificaci√≥n de selecci√≥n autom√°tica
  void _showAutoSelectNotification(BuildContext context, String entityType, String name) {
    final notificationKey = '${entityType}_$name';
    
    // Evitar mostrar la misma notificaci√≥n m√°s de una vez
    if (_notifiedAutoSelections.contains(notificationKey)) {
      return;
    }
    
    _notifiedAutoSelections.add(notificationKey);
    
    ScaffoldMessenger.of(context).hideCurrentSnackBar();
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Se seleccion√≥ autom√°ticamente "$name" por ser el √∫nico $entityType disponible'),
        backgroundColor: Colors.blue.shade700,
        duration: const Duration(seconds: 2),
        behavior: SnackBarBehavior.floating,
        margin: const EdgeInsets.all(16),
        action: SnackBarAction(
          label: 'OK',
          textColor: Colors.white,
          onPressed: () {
            ScaffoldMessenger.of(context).hideCurrentSnackBar();
          },
        ),
      ),
    );
  }
  
  @override
  Widget build(BuildContext context) {
    // Asegurar que el scroll est√© en la posici√≥n inicial al construir el widget
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_scrollController.hasClients) {
        _scrollController.jumpTo(0);
      }
    });

    return BlocConsumer<PostRegisterBloc, PostRegisterState>(
      listenWhen: (previous, current) {
        // Escuchar cambios relevantes
        return previous.isLoading != current.isLoading ||
          previous.errorMessage != current.errorMessage ||
          previous.countries != current.countries ||
          previous.unions != current.unions ||
          previous.localFields != current.localFields ||
          previous.clubs != current.clubs ||
          previous.selectedCountry != current.selectedCountry ||
          previous.selectedUnion != current.selectedUnion ||
          previous.selectedLocalField != current.selectedLocalField ||
          previous.selectedClub != current.selectedClub ||
          previous.isClubInfoSaved != current.isClubInfoSaved ||
          previous.isPostRegisterCompleted != current.isPostRegisterCompleted ||
          previous.completePostRegisterError != current.completePostRegisterError;
      },
      listener: (context, PostRegisterState state) {
        // Actualizar estados locales seg√∫n el estado del bloc
        setState(() {
          countries = state.countries;
          unions = state.unions;
          localFields = state.localFields;
          clubs = state.clubs;
          clubTypes = state.clubTypes;
          classes = state.classes;
          
          selectedCountry = state.selectedCountry;
          selectedUnion = state.selectedUnion;
          selectedLocalField = state.selectedLocalField;
          selectedClub = state.selectedClub;
          selectedClubType = state.selectedClubType;
          selectedClass = state.selectedClass;
          
          canSelectUnion = selectedCountry != null;
          canSelectLocalField = selectedUnion != null;
          canSelectClub = selectedLocalField != null;
          canSelectClubType = selectedClub != null;
          canSelectClass = selectedClubType != null;
          
          isClubInfoComplete = selectedCountry != null && 
                              selectedUnion != null && 
                              selectedLocalField != null && 
                              selectedClub != null &&
                              selectedClubType != null &&
                              selectedClass != null;
          
          // Actualizar los campos de texto
          if (selectedCountry != null) _countryController.text = selectedCountry!.name;
          if (selectedUnion != null) _unionController.text = selectedUnion!.name;
          if (selectedLocalField != null) _localFieldController.text = selectedLocalField!.name;
          if (selectedClub != null) _clubController.text = selectedClub!.name;
          if (selectedClubType != null) _clubTypeController.text = selectedClubType!.name;
          if (selectedClass != null) _classController.text = selectedClass!.name;
        });
        
        // Detectar y notificar selecciones autom√°ticas
        // Para Pa√≠s
        if (state.countries.length == 1 && state.selectedCountry != null) {
          _showAutoSelectNotification(context, 'pa√≠s', state.selectedCountry!.name);
        }
        
        // Para Uni√≥n
        if (state.unions.length == 1 && state.selectedUnion != null) {
          _showAutoSelectNotification(context, 'uni√≥n', state.selectedUnion!.name);
        }
        
        // Para Campo Local
        if (state.localFields.length == 1 && state.selectedLocalField != null) {
          _showAutoSelectNotification(context, 'campo local', state.selectedLocalField!.name);
        }
        
        // Para Club
        if (state.clubs.length == 1 && state.selectedClub != null) {
          _showAutoSelectNotification(context, 'club', state.selectedClub!.name);
        }
        
        // Mostrar mensaje de √©xito SOLO cuando el estado isClubInfoSaved cambia a true
        if (state.isClubInfoSaved && !_didShowSuccessMessage && state.errorMessage == null) {
          _didShowSuccessMessage = true; // Marcar primero para evitar m√∫ltiples mensajes
          
          // Mostrar el SnackBar despu√©s de marcar la bandera
          _showSuccessSnackBar(context);
        }
        
        // Mostrar mensaje cuando el post-registro se haya completado exitosamente
        if (state.isPostRegisterCompleted) {
          _showSuccessSnackBar(context, 'Registro completado exitosamente. Ahora puedes acceder a todas las funciones de la aplicaci√≥n.');
        }
        
        // Mostrar error si hubo problema al completar el post-registro
        if (state.completePostRegisterError != null) {
          _showErrorSnackBar(context, state.completePostRegisterError!);
        }
        
        // Mostrar errores o advertencias si existen
        if (state.errorMessage != null) {
          // Si el error es porque el usuario ya est√° registrado, mostrarlo como advertencia
          if (state.errorMessage!.contains('ya est√° registrado')) {
            _showWarningSnackBar(context, state.errorMessage!);
          } else {
            // Para otros errores, mostrar como error
            _showErrorSnackBar(context, state.errorMessage!);
          }
        }
      },
      builder: (context, state) {
        return Padding(
          padding: const EdgeInsets.only(bottom: 20),
          child: Form(
            key: _formKey,
            child: SingleChildScrollView(
              controller: _scrollController,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  const Text(
                    'INFORMACI√ìN DE CLUB',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: sacBlack,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const Text(
                    'Selecciona de cada secci√≥n la informaci√≥n que corresponde a tus datospara continuar.',
                    style: TextStyle(
                      fontSize: 12,
                      color: sacBlack,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 14),

                  GestureDetector(
                    onTap: _showCountrySelectionModal,
                    child: CustomSelectorData(
                      labelText: '¬øDE QUE PA√çS ERES?',
                      prefixIcon: Icons.language,
                      controller: _countryController,
                    ),
                  ),
                  
                  GestureDetector(
                    onTap: canSelectUnion ? _showUnionSelectionModal : null,
                    child: Opacity(
                      opacity: canSelectUnion ? 1.0 : 0.5,
                      child: CustomSelectorData(
                        labelText: '¬øA QUE UNI√ìN PERTENECES?',
                        prefixIcon: Icons.business,
                        controller: _unionController,
                      ),
                    ),
                  ),
                  
                  GestureDetector(
                    onTap: canSelectLocalField
                        ? _showLocalFieldSelectionModal
                        : null,
                    child: Opacity(
                      opacity: canSelectLocalField ? 1.0 : 0.5,
                      child: CustomSelectorData(
                        labelText: '¬øA QUE CAMPO PERTENECES?',
                        prefixIcon: Icons.location_city,
                        controller: _localFieldController,
                      ),
                    ),
                  ),

                  GestureDetector(
                    onTap: canSelectClub ? _showClubSelectionModal : null,
                    child: Opacity(
                      opacity: canSelectClub ? 1.0 : 0.5,
                      child: CustomSelectorData(
                        labelText: '¬øA QUE CLUB ASISTES?',
                        prefixIcon: Icons.groups,
                        controller: _clubController,
                      ),
                    ),
                  ),

                  GestureDetector(
                    onTap: canSelectClubType
                        ? _showClubTypeSelectionModal
                        : null,
                    child: Opacity(
                      opacity: canSelectClubType ? 1.0 : 0.5,
                      child: CustomSelectorData(
                        labelText: 'TIPO DE CLUB',
                        prefixIcon: Icons.category,
                        controller: _clubTypeController,
                      ),
                    ),
                  ),

                  GestureDetector(
                    onTap: canSelectClass ? _showClassSelectionModal : null,
                    child: Opacity(
                      opacity: canSelectClass ? 1.0 : 0.5,
                      child: CustomSelectorData(
                        labelText: '¬øA QUE CLASE PERTENECES?',
                        prefixIcon: Icons.school,
                        controller: _classController,
                      ),
                    ),
                  ),

                  const SizedBox(height: 20),

                  ElevatedButton(
                    onPressed: state.isLoading ||
                            !isClubInfoComplete ||
                            state.isClubInfoSaved
                        ? null
                        : _saveClubInfo,
                    child: state.isLoading
                        ? const CupertinoActivityIndicator(
                            color: sacRed,
                          )
                        : Text(
                            state.isClubInfoSaved ? 'Datos Guardados ‚úì' : 'Guardar Datos',
                            style: TextStyle(
                                color: state.isClubInfoSaved
                                    ? Colors.grey
                                    : Colors.white,
                                fontSize: 18,
                                fontWeight: FontWeight.bold)),
                  ),

                  if (state.isClubInfoSaved) ...[
                    const SizedBox(height: 16),
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.green.shade50,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: Colors.green.shade200),
                      ),
                      child: const Row(
                        children: [
                          Icon(Icons.check_circle, color: Colors.green),
                          SizedBox(width: 10),
                          Expanded(
                            child: Text(
                              'Informaci√≥n del club guardada correctamente. Ahora puedes continuar para tener acceso a las funciones de la aplicaci√≥n.',
                              style: TextStyle(color: Colors.green),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                  const SizedBox(height: 20),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
  
  // M√©todo para mostrar un SnackBar de √©xito
  void _showSuccessSnackBar(BuildContext context, [String? message]) {
    // Deshabilitar cualquier SnackBar que pudiera estar mostr√°ndose actualmente
    ScaffoldMessenger.of(context).hideCurrentSnackBar();
    
    // Mostrar el nuevo SnackBar
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message ?? 'Informaci√≥n guardada exitosamente'),
        backgroundColor: Colors.green,
        duration: const Duration(seconds: 3),
        action: SnackBarAction(
          label: 'OK',
          textColor: Colors.white,
          onPressed: () {
            ScaffoldMessenger.of(context).hideCurrentSnackBar();
          },
        ),
      ),
    );
  }
  
  // M√©todo para mostrar un SnackBar de advertencia
  void _showWarningSnackBar(BuildContext context, String message) {
    // Deshabilitar cualquier SnackBar que pudiera estar mostr√°ndose actualmente
    ScaffoldMessenger.of(context).hideCurrentSnackBar();
    
    // Mostrar el nuevo SnackBar
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.orange,
        duration: const Duration(seconds: 4),
        action: SnackBarAction(
          label: 'OK',
          textColor: Colors.white,
          onPressed: () {
            ScaffoldMessenger.of(context).hideCurrentSnackBar();
          },
        ),
      ),
    );
  }
  
  // M√©todo para mostrar un SnackBar de error
  void _showErrorSnackBar(BuildContext context, String message) {
    // Deshabilitar cualquier SnackBar que pudiera estar mostr√°ndose actualmente
    ScaffoldMessenger.of(context).hideCurrentSnackBar();
    
    // Mostrar el nuevo SnackBar
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 4),
        action: SnackBarAction(
          label: 'OK',
          textColor: Colors.white,
          onPressed: () {
            ScaffoldMessenger.of(context).hideCurrentSnackBar();
          },
        ),
      ),
    );
  }
}
